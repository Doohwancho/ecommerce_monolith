# A. ë„ë©”ì¸ ë¬¸ì œ í•´ê²°ë°©ì•ˆ

1. ê²°ì œ ìš”ì²­ ì‹œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì •ì˜í•˜ê³ , 
2. ê° ìƒí™©ì— ëŒ€í•œ ì‹œìŠ¤í…œì˜ ëŒ€ì‘ ë°©ì•ˆì„ ëª…ì‹œí•˜ì—¬ ê²°ì œ ì²˜ë¦¬ì˜ ì•ˆì •ì„±ê³¼ ì¼ê´€ì„±ì„ ë³´ì¥í•˜ëŠ” ê²ƒì„ ëª©ì ìœ¼ë¡œ í•œë‹¤.

## a. ê²°ì œ ì‹ ì²­ì‹œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ê²½ìš°ì˜ ìˆ˜ 
1. success
    1. immediate success
2. failure 
   1. ëª…ì‹œì  ì‹¤íŒ¨ w/ ì‹¤íŒ¨ ë©”ì‹œì§€
   2. ì¼ì‹œì  ì‹¤íŒ¨ 
   3. timeout 
   4. ì¤‘ë³µ ê²°ì œ ìš”ì²­ (Idempotency)
   5. ê²°ì œ ì¤‘ ì·¨ì†Œ (User Cancellation)
   6. í™˜ë¶ˆ ìš”ì²­ 

## b. í•´ê²°ë°©ì•ˆ 

### 1. ì„±ê³µ ì¼€ì´ìŠ¤ (Happy Path)

#### 1.1. ì¦‰ì‹œ ì„±ê³µ (Immediate Success)

-   **ìƒí™©**: PGì‚¬ì— ê²°ì œ ìš”ì²­ì„ ë³´ë‚¸ í›„, ì¦‰ì‹œ 'ì„±ê³µ' ì‘ë‹µì„ ë°›ì€ ê²½ìš°.
-   **ìš”êµ¬ì‚¬í•­**: ê²°ì œ ìƒíƒœë¥¼ 'ì™„ë£Œ(COMPLETED)'ë¡œ ì¦‰ì‹œ ë³€ê²½í•˜ê³ , ì‚¬ìš©ìì—ê²Œ ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŒì„ ì•Œë ¤ì•¼ í•œë‹¤.
-   **ëŒ€ì‘ ë°©ì•ˆ**:
    1.  `Payment` í…Œì´ë¸”ì—ì„œ í•´ë‹¹ ê²°ì œ ê±´ì˜ ìƒíƒœë¥¼ `COMPLETED`ë¡œ ì—…ë°ì´íŠ¸í•œë‹¤.
    2.  ê²°ì œ ì™„ë£Œ ì‹œê°(`updatedAt`)ì„ ê¸°ë¡í•œë‹¤.
    3.  ì£¼ë¬¸ ì„œë¹„ìŠ¤(Order Service)ì— ê²°ì œ ì™„ë£Œ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰(publish)í•˜ì—¬ í›„ì† ì²˜ë¦¬(ì˜ˆ: ë°°ì†¡ ì‹œì‘)ë¥¼ ìœ„ì„í•œë‹¤.
    4.  ì‚¬ìš©ìì—ê²Œ ê²°ì œ ì™„ë£Œ ì•Œë¦¼(ì´ë©”ì¼, SMS ë“±)ì„ ë³´ë‚¸ë‹¤.

### 2. ì‹¤íŒ¨ ì¼€ì´ìŠ¤ (Failure Cases)

#### 2.1. ëª…ì‹œì  ì‹¤íŒ¨ (Definitive Failure)

-   **ìƒí™©**: PGì‚¬ë¡œë¶€í„° 'ì‹¤íŒ¨' ì‘ë‹µì„ ëª…í™•í•˜ê²Œ ë°›ì€ ê²½ìš°. (ì˜ˆ: í•œë„ ì´ˆê³¼, ì”ì•¡ ë¶€ì¡±, ìœ íš¨í•˜ì§€ ì•Šì€ ì¹´ë“œ ì •ë³´, ì‚¬ìš©ì ì·¨ì†Œ ë“±)
-   **ìš”êµ¬ì‚¬í•­**: ê²°ì œ ìƒíƒœë¥¼ 'ì‹¤íŒ¨(FAILED)'ë¡œ ë³€ê²½í•˜ê³ , ì‹¤íŒ¨ ì›ì¸ì„ ê¸°ë¡í•´ì•¼ í•œë‹¤. ì‚¬ìš©ìì—ê²ŒëŠ” ëª…í™•í•œ ì‹¤íŒ¨ ì‚¬ìœ ë¥¼ ì•ˆë‚´í•´ì•¼ í•œë‹¤. **ì´ ê²½ìš°ëŠ” ì¬ì‹œë„í•´ì„œëŠ” ì•ˆ ëœë‹¤.**
-   **ëŒ€ì‘ ë°©ì•ˆ**:
    1.  `Payment` í…Œì´ë¸”ì˜ ìƒíƒœë¥¼ `FAILED`ë¡œ ì—…ë°ì´íŠ¸í•œë‹¤.
    2.  PGê°€ ì œê³µí•œ ì‹¤íŒ¨ ì½”ë“œì™€ ë©”ì‹œì§€ë¥¼ ë³„ë„ ì»¬ëŸ¼ì— ê¸°ë¡í•˜ì—¬ ì›ì¸ ë¶„ì„ì´ ê°€ëŠ¥í•˜ë„ë¡ í•œë‹¤.
    3.  ì£¼ë¬¸ ì„œë¹„ìŠ¤ì— ê²°ì œ ì‹¤íŒ¨ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•œë‹¤.
    4.  ì‚¬ìš©ìì—ê²Œ "ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤." ì™€ ê°™ì´ ì´í•´í•˜ê¸° ì‰¬ìš´ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì£¼ê³ , ì¬ê²°ì œë¥¼ ìœ ë„í•œë‹¤.

#### 2.2. ì¼ì‹œì  ì‹¤íŒ¨ (Transient Failure)

-   **ìƒí™©**: PGì‚¬ ì‹œìŠ¤í…œì˜ ì¼ì‹œì ì¸ ì˜¤ë¥˜, ì—°ë™ëœ ì€í–‰ ì‹œìŠ¤í…œì˜ ê°„í—ì  ì¥ì•  ë“±ìœ¼ë¡œ ì¸í•´ ì¼ì‹œì ìœ¼ë¡œ 'ì‹¤íŒ¨' ì‘ë‹µì„ ë°›ì€ ê²½ìš°.
-   **ìš”êµ¬ì‚¬í•­**: ì‹œìŠ¤í…œì€ ìë™ìœ¼ë¡œ ì œí•œëœ íšŸìˆ˜ë§Œí¼ ì¬ì‹œë„ë¥¼ ìˆ˜í–‰í•´ì•¼ í•œë‹¤. ëª¨ë“  ì¬ì‹œë„ í›„ì—ë„ ì‹¤íŒ¨ ì‹œ, ìµœì¢…ì ìœ¼ë¡œ 'ì‹¤íŒ¨' ì²˜ë¦¬í•´ì•¼ í•œë‹¤.
-   **ëŒ€ì‘ ë°©ì•ˆ**:
    1.  `Payment` í…Œì´ë¸”ì˜ `attemptCount`(ì‹œë„ íšŸìˆ˜)ë¥¼ 1 ì¦ê°€ì‹œí‚¨ë‹¤.
    2.  **Exponential Backoff** ì „ëµì„ ì‚¬ìš©í•˜ì—¬ ì¬ì‹œë„ ê°„ê²©ì„ ì ì°¨ ëŠ˜ë ¤ê°€ë©° ìµœëŒ€ 2~3íšŒ ì¬ì‹œë„í•œë‹¤. (ì˜ˆ: 1ì´ˆ, 2ì´ˆ, 4ì´ˆ í›„ ì¬ì‹œë„)
    3.  ìµœì¢… ì¬ì‹œë„ê¹Œì§€ ì‹¤íŒ¨í•˜ë©´, **2.1. ëª…ì‹œì  ì‹¤íŒ¨**ì™€ ë™ì¼í•˜ê²Œ `FAILED` ìƒíƒœë¡œ ì²˜ë¦¬í•œë‹¤.
    4.  ì¬ì‹œë„ ì¤‘ì—ëŠ” `Payment`ì˜ ìƒíƒœë¥¼ `PROCESSING`ìœ¼ë¡œ ìœ ì§€í•œë‹¤.

#### 2.3. ì‘ë‹µ ì‹œê°„ ì´ˆê³¼ (Timeout / Unknown State)

-   **ìƒí™©**: PGì‚¬ì— ê²°ì œ ìš”ì²­ì„ ë³´ëƒˆìœ¼ë‚˜, ì •í•´ì§„ ì‹œê°„(ì˜ˆ: 30ì´ˆ) ë‚´ì— ì•„ë¬´ëŸ° ì‘ë‹µë„ ë°›ì§€ ëª»í•œ ê²½ìš°. **ì‚¬ìš©ìê°€ ì‹¤ì œë¡œ ëˆì„ ì§€ë¶ˆí–ˆì„ ìˆ˜ë„, ì•„ë‹ ìˆ˜ë„ ìˆëŠ” ê°€ì¥ ìœ„í—˜í•œ ìƒíƒœ.**
-   **ìš”êµ¬ì‚¬í•­**: ê²°ì œ ìƒíƒœë¥¼ ì„ì˜ë¡œ 'ì„±ê³µ' ë˜ëŠ” 'ì‹¤íŒ¨' ì²˜ë¦¬í•´ì„œëŠ” ì•ˆ ëœë‹¤. ìƒíƒœë¥¼ 'ì²˜ë¦¬ ì¤‘(PROCESSING)' ë˜ëŠ” 'í™•ì¸ í•„ìš”(UNKNOWN)'ë¡œ ìœ ì§€í•˜ê³ , ë°˜ë“œì‹œ ë³„ë„ì˜ í”„ë¡œì„¸ìŠ¤ë¥¼ í†µí•´ ì‹¤ì œ ê²°ì œ ê²°ê³¼ë¥¼ í™•ì¸í•´ì•¼ í•œë‹¤. **ì ˆëŒ€ ìš”ì²­ì„ ì¬ì‹œë„í•´ì„œëŠ” ì•ˆ ëœë‹¤.**
-   **ëŒ€ì‘ ë°©ì•ˆ**:
    1.  `Payment`ì˜ ìƒíƒœë¥¼ `PROCESSING`ìœ¼ë¡œ ìœ ì§€í•œë‹¤.
    2.  ì‚¬ìš©ìì—ê²ŒëŠ” "ê²°ì œ ê²°ê³¼ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”." ì™€ ê°™ì´ ì•ˆë‚´í•œë‹¤.
    3.  **ê²°ì œ ìƒíƒœ í™•ì¸ ìŠ¤ì¼€ì¤„ëŸ¬(Reconciliation Job)** ë¥¼ í†µí•´ ì¼ì • ì‹œê°„ ê°„ê²©(ì˜ˆ: 5ë¶„, 10ë¶„, 30ë¶„ í›„)ìœ¼ë¡œ PGì‚¬ì— í•´ë‹¹ ê±°ë˜(`paymentKey` ë˜ëŠ” `orderId`)ì˜ ìƒíƒœë¥¼ ì¡°íšŒí•˜ëŠ” APIë¥¼ í˜¸ì¶œí•œë‹¤.
    4.  ìƒíƒœ ì¡°íšŒ APIë¥¼ í†µí•´ í™•ì¸ëœ ìµœì¢… ê²°ê³¼(ì„±ê³µ ë˜ëŠ” ì‹¤íŒ¨)ë¥¼ ë°”íƒ•ìœ¼ë¡œ `Payment`ì˜ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•œë‹¤.

### 3. ì‹œìŠ¤í…œ ë° ì—£ì§€ ì¼€ì´ìŠ¤ (System & Edge Cases)

#### 3.1. ì¤‘ë³µ ê²°ì œ ìš”ì²­ (Idempotency)

-   **ìƒí™©**: ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë‚˜ ì‚¬ìš©ì ì‹¤ìˆ˜(ì˜ˆ: 'ê²°ì œí•˜ê¸°' ë²„íŠ¼ ë”ë¸” í´ë¦­)ë¡œ ì¸í•´ ë™ì¼í•œ `orderId`ì— ëŒ€í•œ ê²°ì œ ìš”ì²­ì´ ì§§ì€ ì‹œê°„ ë‚´ì— ì—¬ëŸ¬ ë²ˆ ë“¤ì–´ì˜¨ ê²½ìš°.
-   **ìš”êµ¬ì‚¬í•­**: ì‹œìŠ¤í…œì€ ë™ì¼ ì£¼ë¬¸ì— ëŒ€í•´ ê²°ì œê°€ ì¤‘ë³µìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë°©ì§€í•´ì•¼ í•œë‹¤. ì´ë¥¼ ìœ„í•´ **ë©±ë“±ì„±**ì„ ë³´ì¥í•´ì•¼ í•œë‹¤.
-   **ëŒ€ì‘ ë°©ì•ˆ**:
    1.  ê²°ì œ ìš”ì²­ì„ ë°›ìœ¼ë©´ `orderId`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ `Payment` í…Œì´ë¸”ì„ ì¡°íšŒí•œë‹¤.
    2.  ì´ë¯¸ `COMPLETED` ìƒíƒœì¸ ê²°ì œ ê±´ì´ ì¡´ì¬í•˜ë©´, ìƒˆë¡œìš´ ê²°ì œë¥¼ ì§„í–‰í•˜ì§€ ì•Šê³  ê¸°ì¡´ì˜ ì„±ê³µ ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤.
    3.  `PENDING` ë˜ëŠ” `PROCESSING` ìƒíƒœì¸ ê²°ì œ ê±´ì´ ì¡´ì¬í•˜ë©´, ìƒˆë¡œìš´ ê²°ì œë¥¼ ìƒì„±í•˜ì§€ ì•Šê³  í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ê²°ì œì˜ ìƒíƒœë¥¼ ì¡°íšŒí•˜ì—¬ ë°˜í™˜í•œë‹¤. (Locking ë©”ì»¤ë‹ˆì¦˜ ê³ ë ¤)

#### 3.2. ê²°ì œ ì¤‘ ì·¨ì†Œ (User Cancellation)

-   **ìƒí™©**: ì‚¬ìš©ìê°€ ê²°ì œë¥¼ ì§„í–‰í•˜ë˜ ì¤‘(ì˜ˆ: PGì‚¬ ê²°ì œì°½) ì´íƒˆí•˜ê±°ë‚˜ 'ì·¨ì†Œ' ë²„íŠ¼ì„ ëˆ„ë¥¸ ê²½ìš°.
-   **ìš”êµ¬ì‚¬í•­**: ê²°ì œ ìƒíƒœë¥¼ 'ì·¨ì†Œ(CANCELLED)'ë¡œ ë³€ê²½í•˜ê³ , ì¬ê³  ë“± ê´€ë ¨ ë¦¬ì†ŒìŠ¤ë¥¼ ì›ìƒ ë³µêµ¬í•´ì•¼ í•œë‹¤.
-   **ëŒ€ì‘ ë°©ì•ˆ**:
    1.  PGì‚¬ê°€ ì œê³µí•˜ëŠ” ì‚¬ìš©ì ì·¨ì†Œ ì½œë°±(Callback) URLì„ í†µí•´ ìš”ì²­ì„ ìˆ˜ì‹ í•œë‹¤.
    2.  `Payment`ì˜ ìƒíƒœë¥¼ `CANCELLED`ë¡œ ì—…ë°ì´íŠ¸í•œë‹¤.
    3.  ì£¼ë¬¸ ì„œë¹„ìŠ¤ì— ê²°ì œ ì·¨ì†Œ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ì—¬ ì£¼ë¬¸ ì·¨ì†Œ ë° ì¬ê³  ë³µêµ¬ ë¡œì§ì„ ìˆ˜í–‰í•˜ë„ë¡ í•œë‹¤.

## c. flowchart 
### c-1. ì „ì²´ ê²°ì œ flowchart 
```mermaid
flowchart TD
    subgraph "API Layer"
        A["API: POST /payments/process"]
        A_Cancel["API: POST /payments/{id}/cancel"]
    end

    subgraph "Payment Service Logic"
        %% Idempotency Check
        A --> B{DB: findByOrderId};
        B -- ì—†ìŒ(New Payment) --> F_Begin;
        B -- ìˆìŒ(Existing Payment) --> C{ê¸°ì¡´ ê²°ì œ ìƒíƒœ?};
        C -- COMPLETED --> D[ê¸°ì¡´ ì„±ê³µ ê²°ê³¼ ë°˜í™˜];
        C -- PROCESSING/PENDING --> E[í˜„ì¬ ì²˜ë¦¬ ì¤‘ ì•Œë¦¼ ë°˜í™˜];
        C -- FAILED/CANCELLED/UNKNOWN --> F_Begin;

        %% Transaction 1: Initial Save
        F_Begin("TX 1: BEGIN") --> F["DB: Payment ìƒì„±<br>(status: PROCESSING)"];
        F --> F_Commit("TX 1: COMMIT");

        %% Payment Execution (No Transaction)
        F_Commit --> G["PGì‚¬ì— ê²°ì œ ìš”ì²­"];
        G --> H{PG ì‘ë‹µ?};

        %% Success Path
        H -- ì„±ê³µ (Success) --> I_Begin;
        I_Begin("TX 2: BEGIN") --> I["DB: status 'COMPLETED'ë¡œ ë³€ê²½"];
        I --> I_Commit("TX 2: COMMIT");
        I_Commit --> I_Event[ì´ë²¤íŠ¸ ë°œí–‰: PaymentSuccess];
        I_Event --> I_API[API ì„±ê³µ ì‘ë‹µ];

        %% Failure Paths
        H -- ëª…ì‹œì  ì‹¤íŒ¨ (Definitive Failure) --> L_Begin;
        L_Begin("TX 2: BEGIN") --> L["DB: status 'FAILED'ë¡œ ë³€ê²½<br>ì‹¤íŒ¨ ì‚¬ìœ  ê¸°ë¡"];
        L --> L_Commit("TX 2: COMMIT");
        L_Commit --> L_Event[ì´ë²¤íŠ¸ ë°œí–‰: PaymentFailed];
        L_Event --> L_API[API ì‹¤íŒ¨ ì‘ë‹µ];
        
        %% Transient Failure Path
        H -- ì¼ì‹œì  ì‹¤íŒ¨ (Transient) --> O{ì¬ì‹œë„ íšŸìˆ˜?};
        O -- ìµœëŒ€ íšŸìˆ˜ ë¯¸ë§Œ --> G;
        O -- ìµœëŒ€ íšŸìˆ˜ ë„ë‹¬ --> L_Begin;

        %% Timeout Path
        H -- íƒ€ì„ì•„ì›ƒ (Timeout) --> P_Begin;
        P_Begin("TX 2: BEGIN") --> P["DB: status 'UNKNOWN'ìœ¼ë¡œ ë³€ê²½"];
        P --> P_Commit("TX 2: COMMIT");
        P_Commit --> P_API[API ì²˜ë¦¬ ì¤‘ ì‘ë‹µ];
        
        %% Cancellation Path
        A_Cancel --> W{DB: findByOrderId};
        W -- ì—†ìŒ --> W_Fail[API: 404 Not Found ì‘ë‹µ];
        W -- ìˆìŒ --> X{ê²°ì œ ìƒíƒœ?};
        X -- PROCESSING/PENDING --> Y_Begin;
        Y_Begin("TX: BEGIN") --> Y["DB: status 'CANCELLED'ë¡œ ë³€ê²½"];
        Y --> Y_Commit("TX: COMMIT");
        Y_Commit --> Y_Event[ì´ë²¤íŠ¸ ë°œí–‰: PaymentCancelled];
        Y_Event --> Y_API[API: ì·¨ì†Œ ì„±ê³µ ì‘ë‹µ];
        X -- COMPLETED --> X_Fail[API: í™˜ë¶ˆ í•„ìš” ì—ëŸ¬ ì‘ë‹µ];
    end

    subgraph "Scheduler (Background Job)"
        R[Scheduler: 5ë¶„ë§ˆë‹¤ ì‹¤í–‰] --> S{"DB: 5ë¶„ ê²½ê³¼í•œ<br>'UNKNOWN' ê±´ ì¡°íšŒ"};
        S -- ìˆìŒ --> T[PGì‚¬ì— ìƒíƒœ ì¡°íšŒ ìš”ì²­];
        T --> U{ì¡°íšŒ ê²°ê³¼?};
        %% Scheduler's update also uses transactions
        U -- PG ì‘ë‹µ: ì„±ê³µ --> I_Begin;
        U -- PG ì‘ë‹µ: ì‹¤íŒ¨ --> L_Begin;
    end

    %% Styling
    style A fill:#9f9,stroke:#333,stroke-width:2px
    style A_Cancel fill:#9f9,stroke:#333,stroke-width:2px
    style R fill:#f9f,stroke:#333,stroke-width:2px
    %% Styling for Transaction Nodes
    style F_Begin fill:#f0ad4e,stroke:#333,stroke-width:2px
    style F_Commit fill:#f0ad4e,stroke:#333,stroke-width:2px
    style I_Begin fill:#f0ad4e,stroke:#333,stroke-width:2px
    style I_Commit fill:#f0ad4e,stroke:#333,stroke-width:2px
    style L_Begin fill:#f0ad4e,stroke:#333,stroke-width:2px
    style L_Commit fill:#f0ad4e,stroke:#333,stroke-width:2px
    style P_Begin fill:#f0ad4e,stroke:#333,stroke-width:2px
    style P_Commit fill:#f0ad4e,stroke:#333,stroke-width:2px
    style Y_Begin fill:#f0ad4e,stroke:#333,stroke-width:2px
    style Y_Commit fill:#f0ad4e,stroke:#333,stroke-width:2px
```

### c-2. í™˜ë¶ˆ flowchart
```mermaid
flowchart TD
    subgraph "API Layer & Sync Logic (ì¦‰ì‹œ ì‘ë‹µ)"
        A["API: POST /payments/{orderId}/refund<br>Body: { amount, reason }"]
        A --> B{DB: findByOrderId};
        B -- ì—†ìŒ --> C[API: 404 Not Found ì‘ë‹µ];
        B -- ìˆìŒ --> D{ì›ë³¸ ê²°ì œ ìƒíƒœ 'COMPLETED'?};
        D -- ì•„ë‹ˆì˜¤ --> E["API: 400 Bad Request ì‘ë‹µ<br>(í™˜ë¶ˆ ë¶ˆê°€ ìƒíƒœ)"];
        D -- ì˜ˆ --> F{í™˜ë¶ˆ ê¸ˆì•¡ ìœ íš¨í•œê°€?<br>ì›ë³¸ ê¸ˆì•¡ ì´í•˜};
        F -- ì•„ë‹ˆì˜¤ --> G["API: 400 Bad Request ì‘ë‹µ<br>(ì›ë³¸ ê¸ˆì•¡ ì´ˆê³¼)"];
        F -- ì˜ˆ --> H["DB: 'refunds' í…Œì´ë¸”ì— ë°ì´í„° ìƒì„±<br>status: REFUND_REQUESTED"];
        H --> I["API: 202 Accepted ì‘ë‹µ<br>('í™˜ë¶ˆ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤')"];
    end

    subgraph "Scheduler & Async Logic (ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬)"
        J[Scheduler: 1ë¶„ë§ˆë‹¤ ì‹¤í–‰] --> K{"DB: 'REFUND_REQUESTED'<br>ìƒíƒœì¸ í™˜ë¶ˆ ê±´ ì¡°íšŒ"};
        K -- ì²˜ë¦¬í•  ê±´ ì—†ìŒ --> K_End(( ))
        K -- ì²˜ë¦¬í•  ê±´ ìˆìŒ --> L["DB: status<br>'REFUND_PROCESSING'ìœ¼ë¡œ ë³€ê²½"];
        L --> M[PGì‚¬ì— í™˜ë¶ˆ ìš”ì²­];
        M --> N{PG ì‘ë‹µ?};
        
        N -- ì„±ê³µ --> O["DB: status 'REFUND_COMPLETED'<br>ì²˜ë¦¬ ì‹œê° ê¸°ë¡"];
        N -- ì‹¤íŒ¨ --> P["DB: status 'REFUND_FAILED'<br>ì²˜ë¦¬ ì‹œê° ê¸°ë¡"];

        O --> Q[ì´ë²¤íŠ¸ ë°œí–‰ - RefundSuccess<br>-> ì‚¬ìš©ìì—ê²Œ í™˜ë¶ˆ ì™„ë£Œ ì•Œë¦¼];
        P --> R[ì´ë²¤íŠ¸ ë°œí–‰ - RefundFailed<br>-> ìš´ì˜íŒ€ì— ì‹¤íŒ¨ ì•Œë¦¼];
    end
    
    %% Styling
    style A fill:#9cf,stroke:#333,stroke-width:2px
    style J fill:#f9f,stroke:#333,stroke-width:2px
    style I fill:#9f9,stroke:#333,stroke-width:1px
```

### c-3. case1) ëª…ì‹œì  ì‹¤íŒ¨

```mermaid
flowchart TD
    A["API: ê²°ì œ ìš”ì²­ ì ‘ìˆ˜"] --> B["DB: Payment ìƒì„±<br>(status: PROCESSING)"];
    B --> C["PGì‚¬ì— ê²°ì œ ìš”ì²­"];
    C --> D{PG ì‘ë‹µ?};
    D -- "ëª…ì‹œì  ì‹¤íŒ¨ (ì”ì•¡ ë¶€ì¡± ë“±)" --> E["DB: status 'FAILED'ë¡œ ë³€ê²½<br>ì‹¤íŒ¨ ì‚¬ìœ  ê¸°ë¡"];
    E --> F["ì´ë²¤íŠ¸ ë°œí–‰ (PaymentFailed)"];
    F --> G["API: ì‚¬ìš©ìì—ê²Œ ì‹¤íŒ¨ ì‘ë‹µ"];
```
*PGë¡œë¶€í„° 'ì”ì•¡ ë¶€ì¡±' ë“± ëª…í™•í•œ ì‹¤íŒ¨ ì½”ë“œë¥¼ ë°›ì•„ ì¦‰ì‹œ 'ì‹¤íŒ¨' ì²˜ë¦¬ë˜ëŠ” íë¦„*

### c-4. ì¼ì‹œì  ì‹¤íŒ¨ (Transient Failure)

```mermaid
flowchart TD
    A["API: ê²°ì œ ìš”ì²­ ì ‘ìˆ˜"] --> B["DB: Payment ìƒì„±<br>(status: PROCESSING)"];
    B --> C["PGì‚¬ì— ê²°ì œ ìš”ì²­"];
    C --> D{PG ì‘ë‹µ?};
    D -- "ì¼ì‹œì  ì‹¤íŒ¨" --> E{ì¬ì‹œë„ íšŸìˆ˜ < ìµœëŒ€ì¹˜?};
    E -- ì˜ˆ --> C;
    E -- ì•„ë‹ˆì˜¤ --> F["DB: status 'FAILED'ë¡œ ë³€ê²½<br>ì‹¤íŒ¨ ì‚¬ìœ  ê¸°ë¡"];
    F --> G["ì´ë²¤íŠ¸ ë°œí–‰ (PaymentFailed)"];
    G --> H["API: ì‚¬ìš©ìì—ê²Œ ìµœì¢… ì‹¤íŒ¨ ì‘ë‹µ"];
```
*PGë¡œë¶€í„° 'ì¼ì‹œì  ì€í–‰ ì˜¤ë¥˜' ë“± ì¬ì‹œë„ ê°€ëŠ¥í•œ ì˜¤ë¥˜ ì½”ë“œë¥¼ ë°›ì•„, ì •í•´ì§„ íšŸìˆ˜ë§Œí¼ ì¬ì‹œë„í•˜ëŠ” íë¦„*

### c-5. íƒ€ì„ì•„ì›ƒ (Timeout)
```mermaid
flowchart TD
    subgraph "ì´ˆê¸° ìš”ì²­ íë¦„"
        A["API: ê²°ì œ ìš”ì²­ ì ‘ìˆ˜"] --> B["DB: Payment ìƒì„±<br>(status: PROCESSING)"];
        B --> C["PGì‚¬ì— ê²°ì œ ìš”ì²­"];
        C --> D{2ì´ˆ ë‚´ ì‘ë‹µ ì—†ìŒ};
        D -- íƒ€ì„ì•„ì›ƒ ë°œìƒ --> E["DB: status 'UNKNOWN'ìœ¼ë¡œ ë³€ê²½"];
        E --> F["API: 'ì²˜ë¦¬ ì¤‘' ì‘ë‹µ"];
    end

    subgraph "ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ì¼€ì¤„ëŸ¬ íë¦„"
        G["Scheduler: 5ë¶„ë§ˆë‹¤ ì‹¤í–‰"] --> H{"DB: 'UNKNOWN' ìƒíƒœ<br>5ë¶„ ì´ìƒ ê²½ê³¼ ê±´ ì¡°íšŒ"};
        H -- ì¡°íšŒ ì„±ê³µ --> I["PGì‚¬ì— ìƒíƒœ ì¡°íšŒ ìš”ì²­"];
        I --> J{ìµœì¢… ê²°ê³¼?};
        J -- ì„±ê³µ --> K["DB: status 'COMPLETED'ë¡œ ë³€ê²½"];
        J -- ì‹¤íŒ¨ --> L["DB: status 'FAILED'ë¡œ ë³€ê²½"];
    end
```

*PGë¡œë¶€í„° ì‘ë‹µì„ ë°›ì§€ ëª»í•´ 'ìƒíƒœ ë¶ˆëª…'ìœ¼ë¡œ ì²˜ë¦¬ëœ í›„, ìŠ¤ì¼€ì¤„ëŸ¬ê°€ í•´ê²°í•˜ëŠ” íë¦„*

### c-6. ì¤‘ë³µ ê²°ì œ ìš”ì²­ (Idempotency)
```mermaid
flowchart TD
    A["API: ê²°ì œ ìš”ì²­ ì ‘ìˆ˜<br>(with orderId)"];
    A --> B{DB: findByOrderId};
    B -- ê¸°ì¡´ ê²°ì œ ì—†ìŒ --> C["ì •ìƒ ê²°ì œ íë¦„ ì‹œì‘..."];
    B -- ê¸°ì¡´ ê²°ì œ ìˆìŒ --> D{ê¸°ì¡´ ê²°ì œ ìƒíƒœ?};
    D -- COMPLETED --> E["API: ê¸°ì¡´ ì„±ê³µ ê²°ê³¼ ì¦‰ì‹œ ë°˜í™˜"];
    D -- PROCESSING/PENDING --> F["API: 'ì´ë¯¸ ì²˜ë¦¬ ì¤‘' ì‘ë‹µ ì¦‰ì‹œ ë°˜í™˜"];
    D -- FAILED/CANCELLED --> C;
```

*ë™ì¼í•œ ì£¼ë¬¸ì— ëŒ€í•´ ê²°ì œ ìš”ì²­ì´ ì—¬ëŸ¬ ë²ˆ ë“¤ì–´ì™”ì„ ë•Œ, ì´ë¥¼ ê°ì§€í•˜ê³  ì²˜ë¦¬í•˜ëŠ” íë¦„*

### c-7. ê²°ì œ ì¤‘ ì·¨ì†Œ (User Cancellation)
```mermaid
flowchart TD
    A["API: POST /payments/{id}/cancel"];
    A --> B{DB: findByOrderId};
    B -- ì—†ìŒ --> C["API: 404 Not Found ì‘ë‹µ"];
    B -- ìˆìŒ --> D{ê²°ì œ ìƒíƒœ?};
    D -- "COMPLETED" --> E["API: 400 Error<br>('í™˜ë¶ˆ'ì„ ìš”ì²­í•´ì•¼ í•¨)"];
    D -- "PROCESSING / PENDING" --> F["DB: status 'CANCELLED'ë¡œ ë³€ê²½"];
    F --> G["ì´ë²¤íŠ¸ ë°œí–‰ (PaymentCancelled)"];
    G --> H["API: ì·¨ì†Œ ì„±ê³µ ì‘ë‹µ"];
```

*ì‚¬ìš©ìê°€ ê²°ì œê°€ ì™„ë£Œë˜ê¸° ì „ì¸ PROCESSING ìƒíƒœì—ì„œ ì·¨ì†Œë¥¼ ìš”ì²­í•˜ëŠ” íë¦„*

### c-8. í™˜ë¶ˆ ìš”ì²­ (Refund Request)
```mermaid
flowchart TD
    subgraph "í™˜ë¶ˆ ìš”ì²­ API íë¦„ (ë™ê¸°)"
        A["API: POST /payments/{id}/refund"];
        A --> B{ì›ë³¸ ê²°ì œê±´<br>ìƒíƒœ 'COMPLETED'?};
        B -- ì˜ˆ --> C["DB: 'refunds' í…Œì´ë¸”ì— ìƒì„±<br>(status: REFUND_REQUESTED)"];
        C --> D["API: 202 Accepted<br>('í™˜ë¶ˆ ìš”ì²­ ì ‘ìˆ˜ë¨')"];
        B -- ì•„ë‹ˆì˜¤ --> E["API: 400 Error<br>(í™˜ë¶ˆ ë¶ˆê°€)"];
    end

    subgraph "í™˜ë¶ˆ ì²˜ë¦¬ ìŠ¤ì¼€ì¤„ëŸ¬ íë¦„ (ë¹„ë™ê¸°)"
        F["Scheduler: 1ë¶„ë§ˆë‹¤ ì‹¤í–‰"] --> G{"DB: 'REFUND_REQUESTED'<br>ìƒíƒœì¸ í™˜ë¶ˆ ê±´ ì¡°íšŒ"};
        G -- ìˆìŒ --> H["DB: status 'REFUND_PROCESSING' ë³€ê²½"];
        H --> I["PGì‚¬ì— í™˜ë¶ˆ ìš”ì²­"];
        I --> J{PG ì‘ë‹µ?};
        J -- ì„±ê³µ --> K["DB: status 'REFUND_COMPLETED' ë³€ê²½"];
        J -- ì‹¤íŒ¨ --> L["DB: status 'REFUND_FAILED' ë³€ê²½"];
        K & L --> M["ì´ë²¤íŠ¸ ë°œí–‰ (í™˜ë¶ˆ ê²°ê³¼)"];
    end
```

*ì™„ë£Œëœ ê²°ì œì— ëŒ€í•´ í™˜ë¶ˆì„ ìš”ì²­í•˜ê³ , ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬ë˜ëŠ” íë¦„*




# B. blocking i/o ë³‘ëª© ë¬¸ì œ í•´ê²°ë°©ì•ˆ
## 1. ë¬¸ì œ
ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ëŠ” ì „í†µì ìœ¼ë¡œ ìŠ¤ë ˆë“œ ë™ì‘ë°©ì‹ì´ ë™ê¸° i/oì´ë‹¤. 

ê·¼ë° PGì‚¬ ìš”ì²­ì´ 200ms~2000ms+ ì—„ì²­ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ìš”ì²­ì´ë‹¤. 

ì–˜ë¥¼ ë™ê¸°ë¡œ ì¡ìœ¼ë©´, ì“°ë ˆë“œê°€ ìš”ì²­ ê¸°ë‹¤ë ¤ì„œ ë™ì‹œ ìš”ì²­ì´ ëª°ë¦¬ëŠ” í™˜ê²½ì—ì„œëŠ” thread starvation ì—ëŸ¬ê°€ ëœ¨ê¸° ì‰½ë‹¤. 


## 2. í•´ê²°ë°©ì•ˆ
ë™ê¸° ë°©ì‹ìœ¼ë¡œ ì“°ë ˆë“œê°€ ê¸´ ìš”ì²­ì„ ê¸°ë‹¤ë¦¬ê²Œ í•˜ì§€ ë§ê³ ,\
ë¹„ë™ê¸° non-blocking i/o ë¥¼ ì¨ì„œ, ë©”ì¸ì“°ë ˆë“œ ëª‡ê°œê°€ ìš”ì²­ ë°›ê¸° & ì½œë°±í•¨ìˆ˜ ì²˜ë¦¬ë§Œ í•˜ê³ , pgì‚¬ ìš”ì²­ ê¸°ë‹¤ë¦¬ëŠ”ê±´ os kernelì— ìœ„ì„, ëë‚˜ë©´ ì•Œë ¤ë‹¬ë¼ê³  í•˜ê¸°


# C. ê¸´ íŠ¸ëœì ì…˜ ë¬¸ì œ í•´ê²°ë°©ì•ˆ 
## 1. ë¬¸ì œ 
íŠ¸ëœì ì…˜ì˜ ë²”ìœ„ë¥¼ ì–¼ë§ˆë‚˜ ì¡ì•„ì•¼ í•˜ë‚˜?

íŠ¸ëœì ì…˜ì˜ ë²”ìœ„ë¥¼ ê²°ì œìš”ì²­ ì²˜ìŒë¶€í„° ëê¹Œì§€ ì¡ìœ¼ë©´, pgì‚¬ ìš”ì²­ì´ 2ì´ˆ+ ê±¸ë ¤ë²„ë¦¬ëŠ” ê²½ìš°, DB ì»¤ë„¥ì…˜ì„ ë„ˆë¬´ ì˜¤ë˜ ë¬¼ê³ ìˆëŠ”ê±° ì•„ë‹ê¹Œ?

DB connectionì´ ê°¯ìˆ˜ë¥¼ ë‹¤ ì¨ë²„ë¦¬ë©´, ì—ëŸ¬ë‚˜ì§€ ì•Šì„ê¹Œ? 

## 2. ê¸°ë°˜ì§€ì‹ ì´í•´ (ì•Œë©´ ìŠ¤í‚µ)

### 2-1. ë™ê¸° i/oì—ì„œ transaction ê³¼ ë¹„ë™ê¸° i/oì—ì„œ transactionì˜ ì°¨ì´ 
- ë™ê¸° i/oì—ì„œ transaction
    - ì „í†µì ì¸ Spring MVCì—ì„œ ì‚¬ìš©í•˜ëŠ” @Transactional ì–´ë…¸í…Œì´ì…˜ì€ ThreadLocal ì´ë¼ëŠ” ê¸°ìˆ ì„ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤. 
    - ThreadLocalì€ "í˜„ì¬ ìŠ¤ë ˆë“œë§Œì˜ ê°œì¸ ì‚¬ë¬¼í•¨"ê³¼ ê°™ìŠµë‹ˆë‹¤. 
    - íŠ¸ëœì­ì…˜ì´ ì‹œì‘ë˜ë©´, íŠ¸ëœì­ì…˜ ì •ë³´(ì»¤ë„¥ì…˜ ë“±)ë¥¼ í˜„ì¬ ìŠ¤ë ˆë“œì˜ ì‚¬ë¬¼í•¨ì— ë„£ì–´ë‘ê³ , ê°™ì€ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” ëª¨ë“  DB ì‘ì—…ì€ ê·¸ ì‚¬ë¬¼í•¨ì— ìˆëŠ” ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
- ë¹„ë™ê¸° i/oì—ì„œ transaction
    - í•˜ë‚˜ì˜ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ê³¼ì •(ë¦¬ì•¡í‹°ë¸Œ ì²´ì¸)ì—ì„œ, I/O ëŒ€ê¸°ê°€ ë°œìƒí•  ë•Œë§ˆë‹¤ ìŠ¤ë ˆë“œê°€ ë‹¤ë¥¸ ì‘ì—…ìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤. 
    - ì¦‰, A ìŠ¤ë ˆë“œê°€ DBì— ì €ì¥ì„ ìš”ì²­í•˜ê³ , ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ B ìŠ¤ë ˆë“œê°€ ë‹¤ë¥¸ ì¼ì„ í•˜ë‹¤ê°€, DB ì‘ë‹µì´ ì˜¤ë©´ C ìŠ¤ë ˆë“œê°€ ê·¸ ë’·ë¶€ë¶„ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - ì´ ë•Œë¬¸ì— ThreadLocal ê¸°ë°˜ì˜ @Transactionalì€ ê¹¨ì§€ê²Œ ë©ë‹ˆë‹¤. C ìŠ¤ë ˆë“œëŠ” A ìŠ¤ë ˆë“œì˜ ê°œì¸ ì‚¬ë¬¼í•¨ì— ì ‘ê·¼í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì´ì£ .
    - í•´ê²°ì±…: TransactionalOperator 
    - ë¦¬ì•¡í‹°ë¸Œ ìŠ¤íŠ¸ë¦¼ ìì²´ì— íŠ¸ëœì­ì…˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì „íŒŒí•˜ë¯€ë¡œ, ìŠ¤ë ˆë“œê°€ ë°”ë€Œì–´ë„ íŠ¸ëœì­ì…˜ì´ ìœ ì§€ë©ë‹ˆë‹¤.
    - `.as(transactionalOperator::transactional);` ì´ëŸ°ì‹ìœ¼ë¡œ ì“´ë‹¤


### 2-2. jvm threadsì™€ connection pool thread 
- spring webfluxëŠ” cpu core ê°¯ìˆ˜ë§Œí¼ ë©”ì¸ ìŠ¤ë ˆë“œ ë§Œë“¤ì–´ì„œ, ì–˜ë„¤ë“¤ì´ http ìš”ì²­ ë°›ì•„ì„œ os kernelì— pgì‚¬ ìš”ì²­ ê¸°ë‹¤ë¦° í›„ ëë‚˜ë©´ ì•ŒëŒ ë‹¬ë¼ê³  ìœ„ì„í•œë‹¤. ì–˜ë„¤ê°€ jvm thread
- jvm threadì™€ ë³„ê°œë¡œ DBì— CRUDí•  ë•Œ ì“°ëŠ” ìŠ¤ë ˆë“œë“¤ì€ connection pool(thread pool)ì— ìˆë‹¤. 
- ë§Œì•½ì— pgì‚¬ ê²°ì œìš”ì²­ì„ DB ìš”ì²­ê³¼ í•¨ê»˜ @Transaction ë²”ìœ„ ì•ˆì— ë„£ì–´ë²„ë¦¬ë©´, ì € connection poolì— ì“°ë ˆë“œê°€ pgì‚¬ ìš”ì²­ì´ ëë‚  ë•Œ ê¹Œì§€ ì•„ë¬´ê²ƒë„ ëª»í•˜ëŠ” ë¬¸ì œê°€ ìƒê¸´ë‹¤. 
- connection poolì•ˆì— ìŠ¤ë ˆë“œê°€ ëª‡ì´ˆì”© ê¸°ë‹¤ë¦¬ëŠ”ë°, DB i/o ìš”ì²­ ë§ì´ì™€ì„œ ë‚¨ëŠ” connectionì´ ì—†ëŠ”ê±¸ 'DB connection pool starvation'ì´ë¼ê³ ë„ í•œë‹¤. 


## 3. ì†”ë£¨ì…˜ 
1. ì¼ë‹¨ pgê²°ì œ ìš”ì²­ì€ ì—„ì²­ ê¸°ë‹ˆê¹Œ transaction ë°–ìœ¼ë¡œ ëº€ë‹¤.
2. íŠ¸ëœì ì…˜ ë²”ìœ„ëŠ” DB i/oë¡œ í•œì •í•œë‹¤. 
3. pgì‚¬ ìš”ì²­ ì „, DBì— `PROCESSING` ìƒíƒœë¡œ ì €ì¥í•˜ê³ , PGì‚¬ ìš”ì²­ ê²°ê³¼ì— ë”°ë¼, ë‹¤ì‹œ DBì— ìƒíƒœë¥¼ ë³€ê²½í•´ì¤€ë‹¤.
4. ê²°ì œ ìš”ì²­ ë„ì¤‘ì— ì·¨ì†Œ ìš”ì²­ì´ ì˜¤ë©´, transaction ë„ì¤‘ì— ê°œì…í•˜ëŠ”ê²Œ ì•„ë‹ˆë¼, í•´ë‹¹ ê²°ì œì˜ ìƒíƒœë¥¼ ë³´ê³  ì–´ë–»ê²Œ ì²˜ë¦¬í• ì§€ ê²°ì •. 
5. ê²°ì œ ì‹¤íŒ¨ì‹œ, ë³´ìƒ íŠ¸ëœì ì…˜ (ê²°ì œ ì‹¤íŒ¨ -> ì´ë²¤íŠ¸ ë‚¨ê¹€ -> order_moduleì—ì„œ ì£¼ë¬¸ ì·¨ì†Œ + ì¬ê³  ë³µì›)



### Before: ê¸´ íŠ¸ëœì­ì…˜
```mermaid
sequenceDiagram
    participant Client
    participant PaymentService
    participant Database
    participant PaymentGateway as PG

    Client->>PaymentService: processPayment() ìš”ì²­
    activate PaymentService

    %% íŠ¸ëœì­ì…˜ ì‹œì‘ %%
    PaymentService->>Database: 1. BEGIN TRANSACTION
    PaymentService->>Database: 2. SAVE Payment (status: PROCESSING)
    
    Note over PaymentService, PG: PGì‚¬ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ<br/>DB íŠ¸ëœì­ì…˜ê³¼ ì»¤ë„¥ì…˜ì´<br/>ê³„ì† ì—´ë ¤ ìˆìŒ (ë¹„íš¨ìœ¨ ë°œìƒ)

    PaymentService->>PaymentGateway as PG: 3. requestPayment()
    PaymentGateway as PG-->>PaymentService: 4. ì‘ë‹µ (e.g. SUCCESS)

    PaymentService->>Database: 5. UPDATE Payment (status: COMPLETED)
    PaymentService->>Database: 6. COMMIT TRANSACTION
    %% íŠ¸ëœì­ì…˜ ì¢…ë£Œ %%
    
    PaymentService-->>Client: ìµœì¢… ì‘ë‹µ
    deactivate PaymentService
```

*í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì´ ì²« DB ì €ì¥ë¶€í„° ì™¸ë¶€ PGì‚¬ í˜¸ì¶œì´ ëë‚œ í›„ ìµœì¢… DB ì—…ë°ì´íŠ¸ê¹Œì§€ ê³„ì† ìœ ì§€ë˜ëŠ” ìƒí™©*

ê°€ì¥ í° ë¬¸ì œì ì€ PGì‚¬ì˜ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ì´ ê³„ì† ì ìœ ëœë‹¤ëŠ” ê²ƒ


### After: ì§§ì€ íŠ¸ëœì­ì…˜ ë¶„ë¦¬ 
```mermaid
sequenceDiagram
    participant Client
    participant PaymentService
    participant Database
    participant PaymentGateway as PG

    Client->>PaymentService: processPayment() ìš”ì²­
    activate PaymentService

    %% íŠ¸ëœì­ì…˜ 1: ì´ˆê¸° ì €ì¥ %%
    PaymentService->>Database: 1a. BEGIN TRANSACTION
    PaymentService->>Database: 1b. SAVE Payment (status: PROCESSING)
    PaymentService->>Database: 1c. COMMIT TRANSACTION
    Note right of Database: ì»¤ë„¥ì…˜ ì¦‰ì‹œ ë°˜í™˜!

    %% ì™¸ë¶€ API í˜¸ì¶œ (íŠ¸ëœì­ì…˜ ì—†ìŒ) %%
    PaymentService->>PaymentGateway as PG: 2. requestPayment()
    PaymentGateway as PG-->>PaymentService: 3. ì‘ë‹µ (e.g. SUCCESS)
    
    %% íŠ¸ëœì­ì…˜ 2: ìƒíƒœ ì—…ë°ì´íŠ¸ %%
    PaymentService->>Database: 4a. BEGIN TRANSACTION
    PaymentService->>Database: 4b. UPDATE Payment (status: COMPLETED)
    PaymentService->>Database: 4c. COMMIT TRANSACTION
    Note right of Database: ì»¤ë„¥ì…˜ ì¦‰ì‹œ ë°˜í™˜!

    PaymentService-->>Client: ìµœì¢… ì‘ë‹µ
    deactivate PaymentService
```


# D. ë°ì´í„° ì •í•©ì„± í•´ê²°ë°©ì•ˆ 
## 1. ë¬¸ì œ 
1. `[TX 1: 'PROCESSING' ì €ì¥ ë° ì»¤ë°‹] <-- (ğŸ’¥ ì‹œìŠ¤í…œ ì¥ì•  ë°œìƒ ê°€ëŠ¥ ì§€ì ) --> [PGì‚¬ í˜¸ì¶œ ë° ìµœì¢… ìƒíƒœ ì—…ë°ì´íŠ¸]` 
    - "ì¢€ë¹„ ë°ì´í„°" ë¬¸ì œ 
    - ë°ì´í„°ë² ì´ìŠ¤ì—ëŠ” PROCESSING ìƒíƒœì˜ ê²°ì œ ê¸°ë¡ì´ ë‚¨ì•„ìˆì§€ë§Œ, ì‹¤ì œë¡œëŠ” PGì‚¬ì— ê²°ì œ ìš”ì²­ì´ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŒ -> ì˜ì›íˆ ì²˜ë¦¬ë˜ì§€ ì•Šê³  DBì— ë‚¨ëŠ” "ì¢€ë¹„ ë°ì´í„°"ê°€ ë¨.
    - ì´ ìƒíƒœë§Œìœ¼ë¡œëŠ” ì‹¤ì œë¡œ ê²°ì œê°€ ì§„í–‰ ì¤‘ì¸ì§€, ì•„ë‹ˆë©´ ì‹œìŠ¤í…œ ì˜¤ë¥˜ë¡œ ë²„ë ¤ì§„ ë°ì´í„°ì¸ì§€ êµ¬ë¶„í•  ìˆ˜ ì—†ìŒ. 
2. `[TX 1: 'PROCESSING' ì €ì¥ ë° ì»¤ë°‹] --> [PGì‚¬ í˜¸ì¶œ ë° ìµœì¢… ìƒíƒœ ì—…ë°ì´íŠ¸] <-- (ğŸ’¥ ì‹œìŠ¤í…œ ì¥ì•  ë°œìƒ ê°€ëŠ¥ ì§€ì ) -->  [í›„ì²˜ë¦¬]`
    - ë°ì´í„° ë¶ˆì¼ì¹˜ ë¬¸ì œ
    - PGì‚¬ í˜¸ì¶œì´ ì„±ê³µí•˜ì—¬ ê³ ê°ì˜ ëˆì€ ì‹¤ì œë¡œ ë¹ ì ¸ë‚˜ê°”ì§€ë§Œ, handlePGResponseì—ì„œ COMPLETEDë¡œ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë‘ ë²ˆì§¸ íŠ¸ëœì­ì…˜ì´ ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°. (ì˜ˆ: DBê°€ ìˆœê°„ì ìœ¼ë¡œ ì¥ì•  ë°œìƒ)
    - PGì‚¬ëŠ” ì„±ê³µ, ìš°ë¦¬ DBëŠ” PROCESSING ìƒíƒœë¡œ ë°ì´í„°ê°€ ë¶ˆì¼ì¹˜
    - ì‚¬ìš©ìëŠ” ëˆì„ ëƒˆëŠ”ë° ì„œë¹„ìŠ¤ì—ì„œëŠ” ê²°ì œê°€ ì™„ë£Œë˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ ë³´ì„ 

## 2. í•´ê²°ë°©ì•ˆ

ì˜¤ë˜ëœ PROCESSING ê±´ ì²˜ë¦¬' ìŠ¤ì¼€ì¤„ëŸ¬ ì¶”ê°€

1. ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œì§: ì¼ì • ì‹œê°„(ì˜ˆ: 1ì‹œê°„)ë§ˆë‹¤, ìƒì„±ëœ ì§€ ì˜¤ë˜ë˜ì—ˆì§€ë§Œ(ì˜ˆ: 30ë¶„ ì´ìƒ) ì—¬ì „íˆ PROCESSING ìƒíƒœì— ë¨¸ë¬¼ëŸ¬ ìˆëŠ” ê²°ì œ ê±´ë“¤ì„ ëª¨ë‘ ì¡°íšŒí•©ë‹ˆë‹¤.
2. ìƒíƒœ ì¡°íšŒ: ì¡°íšŒëœ 'ì¢€ë¹„ ì˜ì‹¬' ê²°ì œ ê±´ë“¤ì˜ paymentKeyë¥¼ ì´ìš©í•´ PGì‚¬ì— ê±°ë˜ ìƒíƒœ ì¡°íšŒ APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
3. ìƒíƒœ ì—…ë°ì´íŠ¸: PGì‚¬ë¡œë¶€í„° ë°›ì€ ì‹¤ì œ ê²°ê³¼(ì„±ê³µ, ì‹¤íŒ¨, ì¡´ì¬í•˜ì§€ ì•ŠìŒ ë“±)ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìš°ë¦¬ DBì˜ ìƒíƒœë¥¼ ìµœì¢…ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ì—¬ ì •í•©ì„±ì„ ë§ì¶¥ë‹ˆë‹¤.
    1. PGì‚¬ì— í•´ë‹¹ ê²°ì œê°€ ì¡´ì¬í•˜ê³  ì„±ê³µí–ˆë‹¤ë©´ -> ìš°ë¦¬ DBë„ **COMPLETED** ë¡œ ë³€ê²½.
    2. PGì‚¬ì— í•´ë‹¹ ê²°ì œê°€ ì¡´ì¬í•˜ê³  ì‹¤íŒ¨í–ˆë‹¤ë©´ -> ìš°ë¦¬ DBë„ **FAILED** ë¡œ ë³€ê²½.
    3. PGì‚¬ì— í•´ë‹¹ ê²°ì œê°€ ì•„ì˜ˆ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ -> 'ì¢€ë¹„ ë°ì´í„°'ì´ë¯€ë¡œ CANCELLED ë˜ëŠ” **FAILED** ë¡œ ë³€ê²½.

